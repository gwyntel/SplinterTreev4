fix: improve message handling in base_cog.py

- Skip storing messages without IDs
- Move message storage to after message sending
- Add better error handling for database operations
- Fix message ID handling for streaming responses

This fixes:
- NOT NULL constraint failed: messages.message_id
- Improved reliability of message history tracking
