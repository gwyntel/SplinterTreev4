fix: improve message formatting and DM handling

- Add format_message_content method for consistent variable formatting
- Move system prompt formatting before history messages
- Format variables in history messages and current content
- Improve DM permission handling with proper fallbacks
- Add better error handling for DM permissions

This fixes issues with system prompt variables not being rendered and improves the reliability of DM summarizing.
